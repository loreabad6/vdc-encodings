<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>VDC encodings</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="io_files/libs/clipboard/clipboard.min.js"></script>
<script src="io_files/libs/quarto-html/quarto.js"></script>
<script src="io_files/libs/quarto-html/popper.min.js"></script>
<script src="io_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="io_files/libs/quarto-html/anchor.min.js"></script>
<link href="io_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="io_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="io_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="io_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="io_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#files-from-mdim-documentation-in-stars" id="toc-files-from-mdim-documentation-in-stars" class="nav-link active" data-scroll-target="#files-from-mdim-documentation-in-stars">Files from <code>mdim</code> documentation in stars</a>
  <ul class="collapse">
  <li><a href="#write-with-stars" id="toc-write-with-stars" class="nav-link" data-scroll-target="#write-with-stars">Write with stars</a></li>
  <li><a href="#read-back-with-stars" id="toc-read-back-with-stars" class="nav-link" data-scroll-target="#read-back-with-stars">Read back with stars</a></li>
  <li><a href="#file-structure" id="toc-file-structure" class="nav-link" data-scroll-target="#file-structure">File structure</a></li>
  <li><a href="#read-in-python" id="toc-read-in-python" class="nav-link" data-scroll-target="#read-in-python">Read in Python</a>
  <ul class="collapse">
  <li><a href="#netcdf" id="toc-netcdf" class="nav-link" data-scroll-target="#netcdf">NetCDF</a></li>
  <li><a href="#zarr" id="toc-zarr" class="nav-link" data-scroll-target="#zarr">Zarr</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#files-saved-with-xvec.encode_cf" id="toc-files-saved-with-xvec.encode_cf" class="nav-link" data-scroll-target="#files-saved-with-xvec.encode_cf">Files saved with <code>xvec.encode_cf()</code></a>
  <ul class="collapse">
  <li><a href="#read-with-stars" id="toc-read-with-stars" class="nav-link" data-scroll-target="#read-with-stars">Read with stars</a></li>
  <li><a href="#write-with-stars-1" id="toc-write-with-stars-1" class="nav-link" data-scroll-target="#write-with-stars-1">Write with stars</a></li>
  <li><a href="#check-file-structures" id="toc-check-file-structures" class="nav-link" data-scroll-target="#check-file-structures">Check file structures</a></li>
  <li><a href="#read-back-with-stars-1" id="toc-read-back-with-stars-1" class="nav-link" data-scroll-target="#read-back-with-stars-1">Read back with stars</a></li>
  <li><a href="#reading-back-with-python" id="toc-reading-back-with-python" class="nav-link" data-scroll-target="#reading-back-with-python">Reading back with Python</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">VDC encodings</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: abind</code></pre>
</div>
</div>
<section id="files-from-mdim-documentation-in-stars" class="level1">
<h1>Files from <code>mdim</code> documentation in stars</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">135</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(<span class="dv">10</span>), <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">dim</span>(m)) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"stations"</span>, <span class="st">"time"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>times <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="st">"2022-05-01"</span>) <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">=</span> <span class="fu">st_as_sfc</span>(<span class="fu">c</span>(<span class="st">"POINT(0 1)"</span>, <span class="st">"POINT(3 5)"</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> <span class="fu">st_as_stars</span>(<span class="fu">list</span>(<span class="at">Precipitation =</span> m)) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">st_set_dimensions</span>(<span class="dv">1</span>, <span class="at">values =</span> pts) <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">st_set_dimensions</span>(<span class="dv">2</span>, <span class="at">values =</span> times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="write-with-stars" class="level2">
<h2 class="anchored" data-anchor-id="write-with-stars">Write with stars</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>temp_stars_nc <span class="ot">=</span> <span class="st">"mdim-stars.nc"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>temp_stars_zr <span class="ot">=</span> <span class="st">"mdim-stars.zarr"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_mdim</span>(s, temp_stars_nc)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_mdim</span>(s, temp_stars_zr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="read-back-with-stars" class="level2">
<h2 class="anchored" data-anchor-id="read-back-with-stars">Read back with stars</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_mdim</span>(here<span class="sc">::</span><span class="fu">here</span>(temp_stars_nc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                     Min.   1st Qu.    Median      Mean  3rd Qu.      Max.
Precipitation  0.03524588 0.3224987 0.3772574 0.4289465 0.511113 0.9204841
dimension(s):
         from to     offset  delta refsys point                   values
stations    1  2         NA     NA     NA  TRUE POINT (0 1), POINT (3 5)
time        1  5 2022-05-02 1 days   Date    NA                     NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_mdim</span>(here<span class="sc">::</span><span class="fu">here</span>(temp_stars_zr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                     Min.   1st Qu.    Median      Mean  3rd Qu.      Max.
Precipitation  0.03524588 0.3224987 0.3772574 0.4289465 0.511113 0.9204841
dimension(s):
         from to     offset  delta refsys point                   values
stations    1  2         NA     NA     NA  TRUE POINT (0 1), POINT (3 5)
time        1  5 2022-05-02 1 days   Date    NA                     NULL</code></pre>
</div>
</div>
</section>
<section id="file-structure" class="level2">
<h2 class="anchored" data-anchor-id="file-structure">File structure</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ncmeta<span class="sc">::</span><span class="fu">nc_meta</span>(here<span class="sc">::</span><span class="fu">here</span>(temp_stars_nc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dimension
# A tibble: 2 × 5
     id name     length unlim coord_dim
  &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt;    
1     0 time          5 FALSE TRUE     
2     1 stations      2 FALSE TRUE     

$variable
# A tibble: 6 × 6
     id name          type     ndims natts dim_coord
  &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;    &lt;int&gt; &lt;int&gt; &lt;lgl&gt;    
1     0 Precipitation NC_FLOAT     2     2 FALSE    
2     1 stations      NC_FLOAT     1     0 TRUE     
3     2 time          NC_FLOAT     1     1 TRUE     
4     3 x             NC_FLOAT     1     1 FALSE    
5     4 y             NC_FLOAT     1     1 FALSE    
6     5 geometry      NC_FLOAT     0     2 FALSE    

$attribute
# A tibble: 8 × 4
     id name             variable      value       
  &lt;int&gt; &lt;chr&gt;            &lt;chr&gt;         &lt;named list&gt;
1     0 coordinates      Precipitation &lt;chr [1]&gt;   
2     1 geometry         Precipitation &lt;chr [1]&gt;   
3     0 units            time          &lt;chr [1]&gt;   
4     0 axis             x             &lt;chr [1]&gt;   
5     0 axis             y             &lt;chr [1]&gt;   
6     0 geometry_type    geometry      &lt;chr [1]&gt;   
7     1 node_coordinates geometry      &lt;chr [1]&gt;   
8     0 Conventions      NC_GLOBAL     &lt;chr [1]&gt;   

$extended
# A tibble: 2 × 3
  dimension name     time     
      &lt;int&gt; &lt;chr&gt;    &lt;list&gt;   
1         0 time     &lt;CFTime&gt; 
2         1 stations &lt;lgl [1]&gt;

$axis
# A tibble: 6 × 3
   axis variable      dimension
  &lt;int&gt; &lt;chr&gt;             &lt;int&gt;
1     1 Precipitation         1
2     2 Precipitation         0
3     3 stations              1
4     4 time                  0
5     5 x                     1
6     6 y                     1

$grid
# A tibble: 3 × 4
  grid  ndims variables        nvars
  &lt;chr&gt; &lt;int&gt; &lt;list&gt;           &lt;int&gt;
1 D1,D0     2 &lt;tibble [1 × 1]&gt;     1
2 D0        1 &lt;tibble [1 × 1]&gt;     1
3 D1        1 &lt;tibble [3 × 1]&gt;     3

$source
# A tibble: 1 × 2
  access              source                                   
  &lt;dttm&gt;              &lt;chr&gt;                                    
1 2025-02-10 22:10:14 /home/rstudio/vdc-encodings/mdim-stars.nc

attr(,"class")
[1] "ncmeta"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">dir_tree</span>(here<span class="sc">::</span><span class="fu">here</span>(temp_stars_zr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/rstudio/vdc-encodings/mdim-stars.zarr
├── Precipitation
│   └── 0.0
├── geometry
├── stations
│   └── 0
├── time
│   └── 0
├── x
│   └── 0
└── y
    └── 0</code></pre>
</div>
</div>
</section>
<section id="read-in-python" class="level2">
<h2 class="anchored" data-anchor-id="read-in-python">Read in Python</h2>
<section id="netcdf" class="level3">
<h3 class="anchored" data-anchor-id="netcdf">NetCDF</h3>
<p>Can be read but it is not decoded correctly. Note that the stations are floats and the geometries are placed in a data variable with the name None.</p>
<p>See outputs <a href="https://github.com/loreabad6/vdc-encodings/blob/main/io.ipynb">here</a></p>
<p><img src="mdim-nc-savedwithstars-readwithxvec.png" class="img-fluid"></p>
</section>
<section id="zarr" class="level3">
<h3 class="anchored" data-anchor-id="zarr">Zarr</h3>
<p>Fails.</p>
<p>See <a href="https://github.com/loreabad6/vdc-encodings/blob/main/io.ipynb">Jupyter notebook</a>.</p>
</section>
</section>
</section>
<section id="files-saved-with-xvec.encode_cf" class="level1">
<h1>Files saved with <code>xvec.encode_cf()</code></h1>
<p><strong>CF conventions and netCDF, Zarr</strong> section in <a href="https://github.com/martinfleis/xvec/blob/summary/doc/source/io.ipynb">xvec development documentation</a></p>
<p>Function: <a href="https://github.com/martinfleis/xvec/blob/summary/xvec/accessor.py#L1343">here</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fn_xvec_nc <span class="ot">=</span> <span class="st">"geo-encoded-xvec.nc"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>fn_xvec_zr <span class="ot">=</span> <span class="st">"geo-encoded-xvec.zarr"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="read-with-stars" class="level2">
<h2 class="anchored" data-anchor-id="read-with-stars">Read with stars</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">nc =</span> <span class="fu">read_mdim</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_xvec_nc)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 4 attributes
attribute(s):
              Min.     1st Qu.       Median         Mean      3rd Qu.
population    91.0 9914.000000 20018.000000 69112.566856 46402.250000
unemployment   0.0    3.700000     5.280013     5.775029     7.200000
divorce        0.0    1.964874     3.419198     4.019652     5.765314
age           17.2   27.900000    31.000000    31.127771    34.100000
                      Max.
population    8.863164e+06
unemployment  3.053408e+01
divorce       1.883741e+01
age           5.760000e+01
dimension(s):
       from   to offset delta refsys point
year      1    4   1960    10     NA    NA
county    1 3085     NA    NA WGS 84 FALSE
                                                              values
year                                                            NULL
county MULTIPOLYGON (((-95.34258...,...,MULTIPOLYGON (((-111.3715...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Reading the zarr file crashes R!</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (zr = read_mdim(fn_zr))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="write-with-stars-1" class="level2">
<h2 class="anchored" data-anchor-id="write-with-stars-1">Write with stars</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fn_stars_nc <span class="ot">=</span> <span class="st">"geo-encoded-stars.nc"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fn_stars_zr <span class="ot">=</span> <span class="st">"geo-encoded-stars.zarr"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_mdim</span>(nc, here<span class="sc">::</span><span class="fu">here</span>(fn_stars_nc))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_mdim</span>(nc, here<span class="sc">::</span><span class="fu">here</span>(fn_stars_zr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-file-structures" class="level2">
<h2 class="anchored" data-anchor-id="check-file-structures">Check file structures</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ncmeta<span class="sc">::</span><span class="fu">nc_meta</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_xvec_nc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dimension
# A tibble: 4 × 5
     id name   length unlim coord_dim
  &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt;    
1     0 county   3085 FALSE FALSE    
2     1 part     3172 FALSE FALSE    
3     2 node    80563 FALSE FALSE    
4     3 year        4 FALSE TRUE     

$variable
# A tibble: 14 × 6
      id name               type      ndims natts dim_coord
   &lt;int&gt; &lt;chr&gt;              &lt;chr&gt;     &lt;int&gt; &lt;int&gt; &lt;lgl&gt;    
 1     0 x                  NC_DOUBLE     1     6 FALSE    
 2     1 y                  NC_DOUBLE     1     6 FALSE    
 3     2 part_node_count    NC_INT        1     1 FALSE    
 4     3 interior_ring      NC_BYTE       1     2 FALSE    
 5     4 population         NC_INT        2     3 FALSE    
 6     5 unemployment       NC_DOUBLE     2     4 FALSE    
 7     6 divorce            NC_DOUBLE     2     4 FALSE    
 8     7 age                NC_DOUBLE     2     4 FALSE    
 9     8 node_count         NC_INT        1     1 FALSE    
10     9 lon                NC_DOUBLE     1     6 FALSE    
11    10 lat                NC_DOUBLE     1     6 FALSE    
12    11 year               NC_INT        1     0 TRUE     
13    12 geometry_container NC_DOUBLE     0     9 FALSE    
14    13 spatial_ref        NC_INT        0    11 FALSE    

$attribute
# A tibble: 63 × 4
      id name          variable value       
   &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;    &lt;named list&gt;
 1     0 axis          x        &lt;chr [1]&gt;   
 2     1 units         x        &lt;chr [1]&gt;   
 3     2 standard_name x        &lt;chr [1]&gt;   
 4     3 grid_mapping  x        &lt;chr [1]&gt;   
 5     4 coordinates   x        &lt;chr [1]&gt;   
 6     5 _FillValue    x        &lt;dbl [1]&gt;   
 7     0 axis          y        &lt;chr [1]&gt;   
 8     1 units         y        &lt;chr [1]&gt;   
 9     2 standard_name y        &lt;chr [1]&gt;   
10     3 grid_mapping  y        &lt;chr [1]&gt;   
# ℹ 53 more rows

$extended
# A tibble: 4 × 3
  dimension name   time     
      &lt;int&gt; &lt;chr&gt;  &lt;list&gt;   
1         0 county &lt;lgl [1]&gt;
2         1 part   &lt;lgl [1]&gt;
3         2 node   &lt;lgl [1]&gt;
4         3 year   &lt;lgl [1]&gt;

$axis
# A tibble: 16 × 3
    axis variable        dimension
   &lt;int&gt; &lt;chr&gt;               &lt;int&gt;
 1     1 x                       2
 2     2 y                       2
 3     3 part_node_count         1
 4     4 interior_ring           1
 5     5 population              3
 6     6 population              0
 7     7 unemployment            3
 8     8 unemployment            0
 9     9 divorce                 3
10    10 divorce                 0
11    11 age                     3
12    12 age                     0
13    13 node_count              0
14    14 lon                     0
15    15 lat                     0
16    16 year                    3

$grid
# A tibble: 5 × 4
  grid  ndims variables        nvars
  &lt;chr&gt; &lt;int&gt; &lt;list&gt;           &lt;int&gt;
1 D3,D0     2 &lt;tibble [4 × 1]&gt;     4
2 D0        1 &lt;tibble [3 × 1]&gt;     3
3 D1        1 &lt;tibble [2 × 1]&gt;     2
4 D2        1 &lt;tibble [2 × 1]&gt;     2
5 D3        1 &lt;tibble [1 × 1]&gt;     1

$source
# A tibble: 1 × 2
  access              source                                         
  &lt;dttm&gt;              &lt;chr&gt;                                          
1 2025-02-10 22:10:15 /home/rstudio/vdc-encodings/geo-encoded-xvec.nc

attr(,"class")
[1] "ncmeta"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ncmeta<span class="sc">::</span><span class="fu">nc_meta</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_stars_nc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dimension
# A tibble: 4 × 5
     id name   length unlim coord_dim
  &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt;    
1     0 part     3172 FALSE FALSE    
2     1 node    80563 FALSE TRUE     
3     2 county   3085 FALSE TRUE     
4     3 year        4 FALSE TRUE     

$variable
# A tibble: 14 × 6
      id name            type     ndims natts dim_coord
   &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;    &lt;int&gt; &lt;int&gt; &lt;lgl&gt;    
 1     0 population      NC_FLOAT     2     3 FALSE    
 2     1 crs             NC_CHAR      0     7 FALSE    
 3     2 unemployment    NC_FLOAT     2     3 FALSE    
 4     3 divorce         NC_FLOAT     2     3 FALSE    
 5     4 age             NC_FLOAT     2     3 FALSE    
 6     5 year            NC_FLOAT     1     0 TRUE     
 7     6 county          NC_FLOAT     1     0 TRUE     
 8     7 node            NC_FLOAT     1     0 TRUE     
 9     8 x               NC_FLOAT     1     1 FALSE    
10     9 y               NC_FLOAT     1     1 FALSE    
11    10 node_count      NC_FLOAT     1     0 FALSE    
12    11 part_node_count NC_FLOAT     1     0 FALSE    
13    12 interior_ring   NC_FLOAT     1     0 FALSE    
14    13 geometry        NC_FLOAT     0     6 FALSE    

$attribute
# A tibble: 28 × 4
      id name                        variable   value       
   &lt;int&gt; &lt;chr&gt;                       &lt;chr&gt;      &lt;named list&gt;
 1     0 grid_mapping                population &lt;chr [1]&gt;   
 2     1 coordinates                 population &lt;chr [1]&gt;   
 3     2 geometry                    population &lt;chr [1]&gt;   
 4     0 grid_mapping_name           crs        &lt;chr [1]&gt;   
 5     1 long_name                   crs        &lt;chr [1]&gt;   
 6     2 longitude_of_prime_meridian crs        &lt;dbl [1]&gt;   
 7     3 semi_major_axis             crs        &lt;dbl [1]&gt;   
 8     4 inverse_flattening          crs        &lt;dbl [1]&gt;   
 9     5 spatial_ref                 crs        &lt;chr [1]&gt;   
10     6 crs_wkt                     crs        &lt;chr [1]&gt;   
# ℹ 18 more rows

$extended
# A tibble: 4 × 3
  dimension name   time     
      &lt;int&gt; &lt;chr&gt;  &lt;list&gt;   
1         0 part   &lt;lgl [1]&gt;
2         1 node   &lt;lgl [1]&gt;
3         2 county &lt;lgl [1]&gt;
4         3 year   &lt;lgl [1]&gt;

$axis
# A tibble: 16 × 3
    axis variable        dimension
   &lt;int&gt; &lt;chr&gt;               &lt;int&gt;
 1     1 population              3
 2     2 population              2
 3     3 unemployment            3
 4     4 unemployment            2
 5     5 divorce                 3
 6     6 divorce                 2
 7     7 age                     3
 8     8 age                     2
 9     9 year                    3
10    10 county                  2
11    11 node                    1
12    12 x                       1
13    13 y                       1
14    14 node_count              2
15    15 part_node_count         0
16    16 interior_ring           0

$grid
# A tibble: 5 × 4
  grid  ndims variables        nvars
  &lt;chr&gt; &lt;int&gt; &lt;list&gt;           &lt;int&gt;
1 D3,D2     2 &lt;tibble [4 × 1]&gt;     4
2 D0        1 &lt;tibble [2 × 1]&gt;     2
3 D1        1 &lt;tibble [3 × 1]&gt;     3
4 D2        1 &lt;tibble [2 × 1]&gt;     2
5 D3        1 &lt;tibble [1 × 1]&gt;     1

$source
# A tibble: 1 × 2
  access              source                                          
  &lt;dttm&gt;              &lt;chr&gt;                                           
1 2025-02-10 22:10:15 /home/rstudio/vdc-encodings/geo-encoded-stars.nc

attr(,"class")
[1] "ncmeta"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">dir_tree</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_xvec_zr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/rstudio/vdc-encodings/geo-encoded-xvec.zarr
├── age
│   ├── c
│   │   └── 0
│   │       └── 0
│   └── zarr.json
├── divorce
│   ├── c
│   │   └── 0
│   │       └── 0
│   └── zarr.json
├── geometry_container
│   ├── c
│   └── zarr.json
├── interior_ring
│   ├── c
│   │   └── 0
│   └── zarr.json
├── lat
│   ├── c
│   │   └── 0
│   └── zarr.json
├── lon
│   ├── c
│   │   └── 0
│   └── zarr.json
├── node_count
│   ├── c
│   │   └── 0
│   └── zarr.json
├── part_node_count
│   ├── c
│   │   └── 0
│   └── zarr.json
├── population
│   ├── c
│   │   └── 0
│   │       └── 0
│   └── zarr.json
├── spatial_ref
│   └── zarr.json
├── unemployment
│   ├── c
│   │   └── 0
│   │       └── 0
│   └── zarr.json
├── x
│   ├── c
│   │   ├── 0
│   │   └── 1
│   └── zarr.json
├── y
│   ├── c
│   │   ├── 0
│   │   └── 1
│   └── zarr.json
├── year
│   ├── c
│   │   └── 0
│   └── zarr.json
└── zarr.json</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">dir_tree</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_stars_zr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/rstudio/vdc-encodings/geo-encoded-stars.zarr
├── age
│   ├── 0.0
│   ├── 1.0
│   ├── 10.0
│   ├── 11.0
│   ├── 12.0
│   ├── 2.0
│   ├── 3.0
│   ├── 4.0
│   ├── 5.0
│   ├── 6.0
│   ├── 7.0
│   ├── 8.0
│   └── 9.0
├── county
│   └── 0
├── divorce
│   ├── 0.0
│   ├── 1.0
│   ├── 10.0
│   ├── 11.0
│   ├── 12.0
│   ├── 2.0
│   ├── 3.0
│   ├── 4.0
│   ├── 5.0
│   ├── 6.0
│   ├── 7.0
│   ├── 8.0
│   └── 9.0
├── geometry
├── interior_ring
│   └── 0
├── node
│   └── 0
├── node_count
│   └── 0
├── part_node_count
│   └── 0
├── population
│   ├── 0.0
│   ├── 1.0
│   ├── 10.0
│   ├── 11.0
│   ├── 12.0
│   ├── 2.0
│   ├── 3.0
│   ├── 4.0
│   ├── 5.0
│   ├── 6.0
│   ├── 7.0
│   ├── 8.0
│   └── 9.0
├── unemployment
│   ├── 0.0
│   ├── 1.0
│   ├── 10.0
│   ├── 11.0
│   ├── 12.0
│   ├── 2.0
│   ├── 3.0
│   ├── 4.0
│   ├── 5.0
│   ├── 6.0
│   ├── 7.0
│   ├── 8.0
│   └── 9.0
├── x
│   └── 0
├── y
│   └── 0
└── year
    └── 0</code></pre>
</div>
</div>
</section>
<section id="read-back-with-stars-1" class="level2">
<h2 class="anchored" data-anchor-id="read-back-with-stars-1">Read back with stars</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_mdim</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_stars_nc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 4 attributes
attribute(s):
              Min.     1st Qu.       Median         Mean      3rd Qu.
population    91.0 9914.000000 20018.000000 69112.566856 46402.250000
unemployment   0.0    3.700000     5.280013     5.775029     7.200000
divorce        0.0    1.964874     3.419198     4.019652     5.765315
age           17.2   27.900000    31.000000    31.127771    34.099998
                      Max.
population    8.863164e+06
unemployment  3.053408e+01
divorce       1.883741e+01
age           5.760000e+01
dimension(s):
       from   to offset delta refsys point
year      1    4   1960    10     NA    NA
county    1 3085     NA    NA WGS 84 FALSE
                                                              values
year                                                            NULL
county MULTIPOLYGON (((-95.34258...,...,MULTIPOLYGON (((-111.3715...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_mdim</span>(here<span class="sc">::</span><span class="fu">here</span>(fn_stars_zr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 4 attributes
attribute(s):
              Min.     1st Qu.       Median         Mean      3rd Qu.
age           17.2   27.900000    31.000000    31.127771    34.099998
divorce        0.0    1.964874     3.419198     4.019652     5.765315
population    91.0 9914.000000 20018.000000 69112.566856 46402.250000
unemployment   0.0    3.700000     5.280013     5.775029     7.200000
                      Max.
age           5.760000e+01
divorce       1.883741e+01
population    8.863164e+06
unemployment  3.053408e+01
dimension(s):
       from   to offset delta refsys point
year      1    4   1960    10     NA    NA
county    1 3085     NA    NA WGS 84 FALSE
                                                              values
year                                                            NULL
county MULTIPOLYGON (((-95.34258...,...,MULTIPOLYGON (((-111.3715...</code></pre>
</div>
</div>
</section>
<section id="reading-back-with-python" class="level2">
<h2 class="anchored" data-anchor-id="reading-back-with-python">Reading back with Python</h2>
<p>Both NetCDF and Zarr fail.</p>
<p>See <a href="https://github.com/loreabad6/vdc-encodings/blob/main/io.ipynb">Jupyter notebook</a>.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>